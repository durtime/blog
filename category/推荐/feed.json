{
    "version": "https://jsonfeed.org/version/1",
    "title": "Durtime • All posts by \"推荐\" category",
    "description": "The aroma of black tea no longer exists",
    "home_page_url": "https://durtime.github.io/blog",
    "items": [
        {
            "id": "https://durtime.github.io/blog/posts/aeafe6b5/",
            "url": "https://durtime.github.io/blog/posts/aeafe6b5/",
            "title": "系统接入访问量统计",
            "date_published": "2023-03-13T01:34:41.000Z",
            "content_html": "<h1 id=\"集成ip2region实现离线ip地址定位\"><a class=\"markdownIt-Anchor\" href=\"#集成ip2region实现离线ip地址定位\">#</a> 集成 ip2region 实现离线 IP 地址定位</h1>\n<p>离线 IP 地址定位库主要用于内网或想减少对外访问 http 带来的资源消耗。（代码已兼容支持 jar 包部署）</p>\n<h2 id=\"1-引入依赖\"><a class=\"markdownIt-Anchor\" href=\"#1-引入依赖\">#</a> 1、引入依赖</h2>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 离线IP地址定位库 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.lionsoul<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>ip2region<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.7.2<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"2-添加工具类regionutiljava\"><a class=\"markdownIt-Anchor\" href=\"#2-添加工具类regionutiljava\">#</a> 2、添加工具类 RegionUtil.java</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ruoyi.common.utils;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.File;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.InputStream;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.io.FileUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.lionsoul.ip2region.DataBlock;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.lionsoul.ip2region.DbConfig;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.lionsoul.ip2region.DbSearcher;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.lionsoul.ip2region.Util;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.Logger;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.LoggerFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 根据ip离线查询地址</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> ruoyi</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RegionUtil</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">Logger</span> <span class=\"variable\">log</span> <span class=\"operator\">=</span> LoggerFactory.getLogger(RegionUtil.class);</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">JAVA_TEMP_DIR</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;java.io.tmpdir&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"type\">DbConfig</span> <span class=\"variable\">config</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"type\">DbSearcher</span> <span class=\"variable\">searcher</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 初始化IP库</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 因为jar无法读取文件,复制创建临时文件</span></span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">dbPath</span> <span class=\"operator\">=</span> RegionUtil.class.getResource(<span class=\"string\">&quot;/ip2region/ip2region.db&quot;</span>).getPath();</span><br><span class=\"line\">            <span class=\"type\">File</span> <span class=\"variable\">file</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(dbPath);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!file.exists())</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"type\">String</span> <span class=\"variable\">tmpDir</span> <span class=\"operator\">=</span> System.getProperties().getProperty(JAVA_TEMP_DIR);</span><br><span class=\"line\">                dbPath = tmpDir + <span class=\"string\">&quot;ip2region.db&quot;</span>;</span><br><span class=\"line\">                file = <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(dbPath);</span><br><span class=\"line\">                <span class=\"type\">ClassPathResource</span> <span class=\"variable\">cpr</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ClassPathResource</span>(<span class=\"string\">&quot;ip2region&quot;</span> + File.separator + <span class=\"string\">&quot;ip2region.db&quot;</span>);</span><br><span class=\"line\">                <span class=\"type\">InputStream</span> <span class=\"variable\">resourceAsStream</span> <span class=\"operator\">=</span> cpr.getInputStream();</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resourceAsStream != <span class=\"literal\">null</span>)</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    FileUtils.copyInputStreamToFile(resourceAsStream, file);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            config = <span class=\"keyword\">new</span> <span class=\"title class_\">DbConfig</span>();</span><br><span class=\"line\">            searcher = <span class=\"keyword\">new</span> <span class=\"title class_\">DbSearcher</span>(config, dbPath);</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;bean [&#123;&#125;]&quot;</span>, config);</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;bean [&#123;&#125;]&quot;</span>, searcher);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">catch</span> (Exception e)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            log.error(<span class=\"string\">&quot;init ip region error:&#123;&#125;&quot;</span>, e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 解析IP</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> ip</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title function_\">getRegion</span><span class=\"params\">(String ip)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"comment\">// db</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (searcher == <span class=\"literal\">null</span> || StringUtils.isEmpty(ip))</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                log.error(<span class=\"string\">&quot;DbSearcher is null&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> StringUtils.EMPTY;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"type\">long</span> <span class=\"variable\">startTime</span> <span class=\"operator\">=</span> System.currentTimeMillis();</span><br><span class=\"line\">            <span class=\"comment\">// 查询算法</span></span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">algorithm</span> <span class=\"operator\">=</span> DbSearcher.MEMORY_ALGORITYM;</span><br><span class=\"line\">            <span class=\"type\">Method</span> <span class=\"variable\">method</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">switch</span> (algorithm)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> DbSearcher.BTREE_ALGORITHM:</span><br><span class=\"line\">                    method = searcher.getClass().getMethod(<span class=\"string\">&quot;btreeSearch&quot;</span>, String.class);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> DbSearcher.BINARY_ALGORITHM:</span><br><span class=\"line\">                    method = searcher.getClass().getMethod(<span class=\"string\">&quot;binarySearch&quot;</span>, String.class);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> DbSearcher.MEMORY_ALGORITYM:</span><br><span class=\"line\">                    method = searcher.getClass().getMethod(<span class=\"string\">&quot;memorySearch&quot;</span>, String.class);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">DataBlock</span> <span class=\"variable\">dataBlock</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (Util.isIpAddress(ip) == <span class=\"literal\">false</span>)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                log.warn(<span class=\"string\">&quot;warning: Invalid ip address&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            dataBlock = (DataBlock) method.invoke(searcher, ip);</span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> dataBlock.getRegion();</span><br><span class=\"line\">            <span class=\"type\">long</span> <span class=\"variable\">endTime</span> <span class=\"operator\">=</span> System.currentTimeMillis();</span><br><span class=\"line\">            log.debug(<span class=\"string\">&quot;region use time[&#123;&#125;] result[&#123;&#125;]&quot;</span>, endTime - startTime, result);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">catch</span> (Exception e)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            log.error(<span class=\"string\">&quot;error:&#123;&#125;&quot;</span>, e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> StringUtils.EMPTY;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>3、修改 AddressUtils.java</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ruoyi.common.utils.ip;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.Logger;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.LoggerFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.ruoyi.common.config.RuoYiConfig;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.ruoyi.common.utils.RegionUtil;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 获取地址类</span></span><br><span class=\"line\"><span class=\"comment\"> * </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> ruoyi</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AddressUtils</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">Logger</span> <span class=\"variable\">log</span> <span class=\"operator\">=</span> LoggerFactory.getLogger(AddressUtils.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 未知地址</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">UNKNOWN</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;XX XX&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title function_\">getRealAddressByIP2</span><span class=\"params\">(String ip)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">address</span> <span class=\"operator\">=</span> UNKNOWN;</span><br><span class=\"line\">        <span class=\"comment\">// 内网不查询</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (IpUtils.internalIp(ip))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">&quot;内网IP&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (RuoYiConfig.isAddressEnabled())</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"type\">String</span> <span class=\"variable\">rspStr</span> <span class=\"operator\">=</span> RegionUtil.getRegion(ip);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (StringUtils.isEmpty(rspStr))</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    log.error(<span class=\"string\">&quot;获取地理位置异常 &#123;&#125;&quot;</span>, ip);</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> UNKNOWN;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                String[] obj = rspStr.split(<span class=\"string\">&quot;\\\\|&quot;</span>);</span><br><span class=\"line\">                <span class=\"type\">String</span> <span class=\"variable\">region</span> <span class=\"operator\">=</span> obj[<span class=\"number\">2</span>];</span><br><span class=\"line\">                <span class=\"type\">String</span> <span class=\"variable\">city</span> <span class=\"operator\">=</span> obj[<span class=\"number\">3</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">return</span> String.format(<span class=\"string\">&quot;%s %s&quot;</span>, region, city);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">catch</span> (Exception e)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                log.error(<span class=\"string\">&quot;获取地理位置异常 &#123;&#125;&quot;</span>, e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> address;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>4、添加离线 IP 地址库插件</p>\n<p>下载前端插件相关包和代码实现 ruoyi / 集成 ip2region 离线地址定位.zip</p>\n<p>链接: <a href=\"https://pan.baidu.com/s/13JVC9jm-Dp9PfHdDDylLCQ\">https://pan.baidu.com/s/13JVC9jm-Dp9PfHdDDylLCQ</a> 提取码: y9jt</p>\n<p>5、添加离线 IP 地址库</p>\n<p>在 src/main/resources 下新建 ip2region 复制文件 ip2region.db 到目录下。</p>\n<h1 id=\"在线ip地址统计\"><a class=\"markdownIt-Anchor\" href=\"#在线ip地址统计\">#</a> 在线 Ip 地址统计</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// IP地址查询</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">IP_URL</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;http://whois.pconline.com.cn/ipJson.jsp&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 未知地址</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">UNKNOWN</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;XX XX&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title function_\">getRealAddressByIP</span><span class=\"params\">(String ip)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 内网不查询</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (IpUtils.internalIp(ip))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;内网IP&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (RuoYiConfig.isAddressEnabled())</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">rspStr</span> <span class=\"operator\">=</span> HttpUtils.sendGet(IP_URL, <span class=\"string\">&quot;ip=&quot;</span> + ip + <span class=\"string\">&quot;&amp;json=true&quot;</span>, Constants.GBK);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (StringUtils.isEmpty(rspStr))</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                log.error(<span class=\"string\">&quot;获取地理位置异常 &#123;&#125;&quot;</span>, ip);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> UNKNOWN;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"type\">JSONObject</span> <span class=\"variable\">obj</span> <span class=\"operator\">=</span> JSON.parseObject(rspStr);</span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">region</span> <span class=\"operator\">=</span> obj.getString(<span class=\"string\">&quot;pro&quot;</span>);</span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">city</span> <span class=\"operator\">=</span> obj.getString(<span class=\"string\">&quot;city&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> String.format(<span class=\"string\">&quot;%s %s&quot;</span>, region, city);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">catch</span> (Exception e)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            log.error(<span class=\"string\">&quot;获取地理位置异常 &#123;&#125;&quot;</span>, ip);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> UNKNOWN;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>返回字符串</p>\n<p><img src=\"../assets/Snipaste_2023-03-13_10-32-38.png\" alt=\"返回字符串\"></p>\n<h1 id=\"ip地址统计\"><a class=\"markdownIt-Anchor\" href=\"#ip地址统计\">#</a> Ip 地址统计</h1>\n<p>首先利用 Aop 拦截发送的服务器的请求</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.durtime.frontapi.aspect;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> cn.hutool.http.useragent.UserAgent;</span><br><span class=\"line\"><span class=\"keyword\">import</span> cn.hutool.http.useragent.UserAgentUtil;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.durtime.common.utils.DateUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.durtime.common.utils.StringUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.durtime.common.utils.ip.AddressUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.durtime.common.utils.ip.IpUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.durtime.frontapi.article.service.impl.VisitService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.durtime.noapp.domain.AppVisitRecord;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.annotation.Before;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.Logger;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.LoggerFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.context.request.RequestAttributes;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.text.SimpleDateFormat;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Date;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> kaile</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@className</span> FrontLogAspect</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2023/3/9</span></span><br><span class=\"line\"><span class=\"comment\"> **/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Aspect</span></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">FrontLogAspect</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"type\">Logger</span> <span class=\"variable\">log</span> <span class=\"operator\">=</span> LoggerFactory.getLogger(getClass());</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> VisitService visitService;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//要切入的地方，前端访问的接口  </span></span><br><span class=\"line\">    <span class=\"meta\">@Pointcut(&quot;execution(*  com.durtime.frontapi.controller.FrontArticleController.getList(..))&quot; +</span></span><br><span class=\"line\"><span class=\"meta\">            &quot; || execution(*  com.durtime.frontapi.controller.FrontArticleController.getById(..))&quot; +</span></span><br><span class=\"line\"><span class=\"meta\">            &quot; || execution(*  com.durtime.frontapi.controller.FrontUserController.getCurrentUser(..))&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">logpoint</span><span class=\"params\">()</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 半个小时只记录一次ip</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Before(&quot;logpoint()&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">beforeAction</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//记录开始时间</span></span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">beginTime</span> <span class=\"operator\">=</span> System.currentTimeMillis();</span><br><span class=\"line\">        <span class=\"comment\">// 从请求头中获取所需要的信息</span></span><br><span class=\"line\">        <span class=\"type\">RequestAttributes</span> <span class=\"variable\">ra</span> <span class=\"operator\">=</span> RequestContextHolder.getRequestAttributes();</span><br><span class=\"line\">        <span class=\"type\">ServletRequestAttributes</span> <span class=\"variable\">sra</span> <span class=\"operator\">=</span> (ServletRequestAttributes) ra;</span><br><span class=\"line\">        <span class=\"type\">HttpServletRequest</span> <span class=\"variable\">request</span> <span class=\"operator\">=</span> sra.getRequest();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">UserAgent</span> <span class=\"variable\">ua</span> <span class=\"operator\">=</span> UserAgentUtil.parse(request.getHeader(<span class=\"string\">&quot;User-Agent&quot;</span>));</span><br><span class=\"line\">        <span class=\"comment\">//获取操作系统</span></span><br><span class=\"line\">        <span class=\"comment\">//得到用户的浏览器名</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">browser</span> <span class=\"operator\">=</span> ua.getBrowser().toString();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;浏览器  &quot;</span>+browser);</span><br><span class=\"line\">        <span class=\"comment\">//得到用户的操作系统名</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">os</span> <span class=\"operator\">=</span> ua.getPlatform().toString();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;os  &quot;</span>+os);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取请求地址</span></span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">requestPath</span> <span class=\"operator\">=</span> request.getRequestURI();</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">ip</span> <span class=\"operator\">=</span> IpUtils.getIpAddr(request);</span><br><span class=\"line\">        <span class=\"comment\">//格式换开始时间</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">optTime</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">SimpleDateFormat</span>(<span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">realAddressByIP2</span> <span class=\"operator\">=</span> AddressUtils.getRealAddressByIP2(ip);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">province</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">String</span>(<span class=\"string\">&quot;内网IP&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">city</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">String</span>(<span class=\"string\">&quot;内网IP&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">country</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">String</span>(<span class=\"string\">&quot;内网IP&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//不是内网ip，进行省市的划分</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!IpUtils.internalIp(ip))&#123;</span><br><span class=\"line\">            String[] s = realAddressByIP2.split(<span class=\"string\">&quot; &quot;</span>);</span><br><span class=\"line\">            province = s[<span class=\"number\">0</span>];</span><br><span class=\"line\">            city = s[<span class=\"number\">1</span>];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;*****************************************************************************************************************&quot;</span>);</span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;[访问时间]&gt;&gt;&gt;&gt;&gt; &quot;</span> + optTime);</span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;[访问 IP]&gt;&gt;&gt;&gt;&gt; &quot;</span> + ip);</span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;[访问 地址]&gt;&gt;&gt;&gt;&gt; &quot;</span> + AddressUtils.getRealAddressByIP(ip));</span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;[访问 地址]&gt;&gt;&gt;&gt;&gt; &quot;</span> + province+ <span class=\"string\">&quot; &quot;</span>+city);</span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;[访问路由]&gt;&gt;&gt;&gt;&gt; &quot;</span> + requestPath);</span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;[耗费时间]&gt;&gt;&gt;&gt;&gt; &quot;</span> + (System.currentTimeMillis() - beginTime) + <span class=\"string\">&quot; ms&quot;</span>);</span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;*****************************************************************************************************************\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//如果ip过期，先进行浏览量的增加</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(StringUtils.isEmpty(visitService.getRedisIp(ip)))&#123;</span><br><span class=\"line\">            <span class=\"type\">AppVisitRecord</span> <span class=\"variable\">appVisitRecord</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">AppVisitRecord</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">            appVisitRecord.setIp(ip);</span><br><span class=\"line\">            appVisitRecord.setCountry(country);</span><br><span class=\"line\">            appVisitRecord.setCity(city);</span><br><span class=\"line\">            appVisitRecord.setProvince(province);</span><br><span class=\"line\">            appVisitRecord.setOs(os);</span><br><span class=\"line\">            appVisitRecord.setBrowser(browser);</span><br><span class=\"line\">            appVisitRecord.setCreateTime(DateUtils.getNowDate());</span><br><span class=\"line\">            visitService.addRecord(appVisitRecord);</span><br><span class=\"line\">            visitService.doCountByPass();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//新增ip</span></span><br><span class=\"line\">            visitService.addIp(ip);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>访问量统计服务<br>\n VisitService.java</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.durtime.frontapi.article.service.impl;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.durtime.noapp.domain.AppVisitRecord;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.durtime.noapp.service.IAppVisitRecordService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.Logger;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.LoggerFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Service;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Set;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> kaile</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@className</span> VisitService</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2023/2/1</span></span><br><span class=\"line\"><span class=\"comment\"> **/</span></span><br><span class=\"line\"><span class=\"meta\">@Service</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">VisitService</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"type\">Logger</span> <span class=\"variable\">log</span> <span class=\"operator\">=</span> LoggerFactory.getLogger(getClass());</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">String</span> <span class=\"variable\">prefix</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;vc:&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> RedisTemplate redisTemplate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> IAppVisitRecordService appVisitRecordService;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 初始化访问量</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">initVisitCount</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        redisTemplate.opsForValue().set(<span class=\"string\">&quot;visitcount&quot;</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获取网站访问量 visitcount</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">getVisitCount</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">visitcount</span> <span class=\"operator\">=</span>(<span class=\"type\">int</span>) redisTemplate.opsForValue().get(<span class=\"string\">&quot;visitcount&quot;</span>);</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;visitcount:&quot;</span>+visitcount);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> visitcount;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获取ip</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">getRedisIp</span><span class=\"params\">(String ip)</span>&#123;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">Ip</span> <span class=\"operator\">=</span>(String) redisTemplate.opsForValue().get(prefix+ip);</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;Ip:&quot;</span>+Ip);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Ip;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 设置网站访问量</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> vc</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">setVisitCount</span><span class=\"params\">(<span class=\"type\">int</span> vc)</span>&#123;</span><br><span class=\"line\">        redisTemplate.opsForValue().set(<span class=\"string\">&quot;visitcount&quot;</span>,vc);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 设置ip,30分钟过期</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> ip</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">addIp</span><span class=\"params\">(String ip)</span>&#123;</span><br><span class=\"line\">        redisTemplate.opsForValue().setIfAbsent(prefix+ip,<span class=\"string\">&quot;1&quot;</span>,<span class=\"number\">30</span>, TimeUnit.MINUTES);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">addRecord</span><span class=\"params\">(AppVisitRecord appVisitRecord)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (appVisitRecordService.insertAppVisitRecord(appVisitRecord)&gt;<span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 半小时新增统计,等待自动过期</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">doCountByPass</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        setVisitCount(getVisitCount()+<span class=\"number\">1</span>);</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;统计vc:&quot;</span>+getVisitCount());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"网站访问量获取\"><a class=\"markdownIt-Anchor\" href=\"#网站访问量获取\">#</a> 网站访问量获取</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">visitService.getVisitCount();</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Ip",
                "运维"
            ]
        }
    ]
}